<div class="bg-white rounded-lg shadow-sm border border-slate-200">
  <div class="p-6 border-b border-slate-200">
    <div class="flex justify-between items-center">
      <div>
        <h1 class="text-xl font-bold text-slate-800">Quản lý Tài khoản</h1>
        <p class="text-sm text-slate-500">Danh sách tài khoản và quyền truy cập</p>
      </div>
      <button (click)="showInviteForm = !showInviteForm"
        class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-bold rounded-lg hover:bg-blue-700 shadow-md shadow-blue-200 transition-all transform active:scale-95">
        <i class="fas fa-user-plus mr-2"></i> Mời người dùng
      </button>
    </div>
  </div>

  <div class="p-6">
    <!-- Search -->
    <!-- Search and Filters -->
    <div class="flex flex-col md:flex-row gap-4 mb-6">
      <div class="flex-1">
        <input type="text" [(ngModel)]="searchTerm" (input)="onSearch()" placeholder="Tìm kiếm theo tên, email, SĐT..."
          class="w-full px-4 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
      </div>
      <div class="flex gap-2 overflow-x-auto pb-2 md:pb-0">
        <select [(ngModel)]="filterRole" (change)="onSearch()"
          class="px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-sm min-w-[140px]">
          <option value="">Tất cả Vai trò</option>
          <option value="ADMIN">Quản trị viên</option>
          <option value="LECTURER">Giảng viên</option>
          <option value="STUDENT">Sinh viên</option>
        </select>
        <select [(ngModel)]="filterStatus" (change)="onSearch()"
          class="px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-sm min-w-[140px]">
          <option value="">Tất cả Trạng thái</option>
          <option value="ACTIVE">Hoạt động</option>
          <option value="LOCKED">Đã khóa</option>
          <option value="DISABLED">Vô hiệu hóa</option>
        </select>
        <select [(ngModel)]="filterVerified" (change)="onSearch()"
          class="px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-sm min-w-[150px]">
          <option value="">Tất cả Xác thực</option>
          <option value="true">Đã xác thực</option>
          <option value="false">Chưa xác thực</option>
        </select>
      </div>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto">
      <table class="w-full table-auto border-collapse">
        <thead>
          <tr class="bg-slate-50 border-b border-slate-200">
            <th
              class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider text-center w-12">
              STT</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider cursor-pointer"
              (click)="onSort('name')">
              Họ và tên <i class="fas fa-sort ml-1"></i>
            </th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider cursor-pointer"
              (click)="onSort('email')">
              Email <i class="fas fa-sort ml-1"></i>
            </th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">SĐT</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Giới tính</th>
            <th
              class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider text-center cursor-pointer"
              (click)="onSort('role')">
              Vai trò <i class="fas fa-sort ml-1"></i>
            </th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider text-center">
              Trạng thái</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider text-center">
              Xác thực Email</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider cursor-pointer"
              (click)="onSort('lastLogin')">
              Đăng nhập cuối <i class="fas fa-sort ml-1"></i>
            </th>
            <th class="px-4 py-3 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider">Hành động
            </th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-200">
          <tr *ngFor="let user of paginatedUsers; let i = index" class="hover:bg-slate-50">
            <td class="px-4 py-3 text-sm text-slate-900 text-center">
              {{ (currentPage - 1) * itemsPerPage + i + 1 }}
            </td>
            <td class="px-4 py-3 text-sm font-medium text-slate-900">
              <div class="flex items-center">
                <div class="flex-shrink-0 h-8 w-8 mr-3">
                  <img *ngIf="user.avatar" class="h-8 w-8 rounded-full border border-slate-100 object-cover"
                    [src]="user.avatar" alt="">
                  <div *ngIf="!user.avatar"
                    class="h-8 w-8 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center font-bold text-xs border border-blue-100">
                    {{ user.name?.charAt(0).toUpperCase() }}
                  </div>
                </div>
                {{ user.name }}
              </div>
            </td>
            <td class="px-4 py-3 text-sm text-slate-600">{{ user.email }}</td>
            <td class="px-4 py-3 text-sm text-slate-600">{{ user.phone || '---' }}</td>
            <td class="px-4 py-3 text-sm text-slate-600">{{ getGenderName(user.gender) }}</td>
            <td class="px-4 py-3 text-sm text-center">
              <span class="inline-flex items-center gap-1 px-2 py-0.5 text-[10px] font-medium rounded-full" [class]="user.role === 'ADMIN' ? 'bg-red-50 text-red-600 border-red-100' : 
                         user.role === 'LECTURER' ? 'bg-blue-50 text-blue-600 border-blue-100' : 
                         'bg-green-50 text-green-600 border-green-100'">
                {{ getRoleName(user.role) }}
              </span>
            </td>
            <td class="px-4 py-3 text-sm text-center">
              <span class="inline-flex items-center gap-1 px-2 py-0.5 text-[10px] font-medium rounded-full" [ngClass]="{
                  'bg-emerald-50 text-emerald-600 border-emerald-100': (!user.accountStatus || user.accountStatus === 'ACTIVE'),
                  'bg-amber-50 text-amber-600 border-amber-100': user.accountStatus === 'LOCKED',
                  'bg-slate-100 text-slate-500 border-slate-200': user.accountStatus === 'DISABLED'
                }">
                {{ getStatusName(user.accountStatus) }}
              </span>
            </td>
            <td class="px-4 py-3 text-sm text-center">
              <span class="inline-flex items-center gap-1 px-2 py-0.5 text-[10px] font-medium rounded-full"
                [class]="user.isEmailVerified ? 'bg-green-50 text-green-700' : 'bg-yellow-50 text-yellow-700'">
                <i class="fas" [class]="user.isEmailVerified ? 'fa-check-circle' : 'fa-exclamation-circle'"></i>
                {{ getVerifiedStatus(user.isEmailVerified) }}
              </span>
            </td>
            <td class="px-4 py-3 text-sm text-slate-500 whitespace-nowrap">
              {{ user.lastLogin ? (user.lastLogin | date:'dd/MM/yyyy HH:mm') : '---' }}
            </td>
            <td class="px-4 py-3 text-sm text-center">
              <button (click)="openDeleteModal(user)" class="text-slate-400 hover:text-red-600 transition-colors p-1"
                title="Xóa">
                <i class="fas fa-trash-alt"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="flex justify-between items-center mt-4">
      <div class="text-sm text-slate-600">
        Hiển thị {{ (currentPage - 1) * itemsPerPage + 1 }} - {{ minEnd }} của {{ filteredUsers.length }} kết quả
      </div>
      <div class="flex space-x-2">
        <button (click)="prevPage()" [disabled]="currentPage === 1"
          class="px-3 py-1 border border-slate-300 rounded-md text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">
          Trước
        </button>
        <span class="px-3 py-1 text-sm text-slate-600">
          Trang {{ currentPage }} / {{ totalPages }}
        </span>
        <button (click)="nextPage()" [disabled]="currentPage === totalPages"
          class="px-3 py-1 border border-slate-300 rounded-md text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-50">
          Sau
        </button>
      </div>
    </div>
  </div>
</div>

<div *ngIf="showInviteForm"
  class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 transition-opacity duration-300"
  (mousedown)="handleBackdropClick($event)">

  <div class="bg-white rounded-md shadow-2xl max-w-md w-full mx-4 transform transition-all max-h-[90vh] flex flex-col"
    (mousedown)="$event.stopPropagation()">

    <div class="flex px-6 pt-6 pb-4 items-center justify-between border-b border-slate-200 flex-shrink-0">
      <h3 class="text-slate-500 font-bold text-slate-900">Mời người dùng mới</h3>
      <button (click)="showInviteForm = false" class="text-gray-400 hover:text-gray-600">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <div class="px-6 py-6 overflow-y-auto flex-1">
      <form (ngSubmit)="inviteUser()" class="space-y-4 sm:space-y-6">
        <div class="space-y-2">
          <label class="block text-sm font-semibold text-gray-700">Email người dùng</label>
          <input type="email" [(ngModel)]="inviteEmail" name="email" required placeholder="nhập email để mời..."
            class="block w-full px-3 py-2.5 border border-slate-300 rounded-md text-slate-900 text-sm focus:border-blue-600 outline-none">
        </div>

        <div class="space-y-2">
          <label class="block text-sm font-semibold text-gray-700">Vai trò</label>
          <select [(ngModel)]="inviteRole" name="role" required
            class="block w-full px-3 py-2.5 border border-slate-300 rounded-md text-slate-900 text-sm focus:border-blue-600 outline-none">
            <option *ngFor="let role of availableRoles" [value]="role.name">{{ role.description }}</option>
          </select>
        </div>

        <div class="flex justify-end pt-4">
          <div class="flex gap-3">
            <button type="button" (click)="showInviteForm = false"
              class="rounded-md border border-slate-300 px-4 py-2.5 text-xs text-slate-700 bg-slate-100 hover:bg-slate-200 transition font-semibold">
              Hủy bỏ
            </button>
            <button type="submit" [disabled]="inviting || !inviteEmail"
              class="px-5 py-2.5 bg-blue-600 text-xs rounded-md hover:bg-blue-700 font-semibold text-white border border-transparent shadow-md disabled:opacity-50 transition-all">
              <i *ngIf="inviting" class="fas fa-spinner fa-spin mr-2"></i>
              Gửi lời mời
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>


<div *ngIf="showDeleteModal"
  class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 transition-opacity duration-300"
  (mousedown)="handleBackdropClick($event)">

  <div class="bg-white rounded-xl shadow-xl max-w-sm w-full mx-4 transform transition-all border border-slate-100"
    (mousedown)="$event.stopPropagation()">

    <div class="p-6">
      <div class="flex items-start gap-4">
        <div
          class="flex-shrink-0 w-12 h-12 bg-red-50 text-red-500 rounded-full flex items-center justify-center ring-4 ring-red-50/50">
          <i class="fas fa-exclamation-triangle text-lg"></i>
        </div>

        <div class="flex-1">
          <h3 class="text-lg font-bold text-slate-900 leading-tight">Xóa người dùng?</h3>
          <p class="text-sm text-slate-500 mt-2 leading-relaxed">
            Hành động này sẽ gỡ bỏ vĩnh viễn <span class="font-semibold text-slate-700">{{userToDelete?.name}}</span>.
            Bạn chắc chắn chứ?
          </p>
        </div>
      </div>

      <div class="flex justify-end gap-3 mt-8">
        <button type="button" (click)="closeDeleteModal()" [disabled]="deletingUser"
          class="rounded-md border border-slate-300 px-4 py-2.5 text-xs text-slate-700 bg-slate-100 hover:bg-slate-200 transition font-semibold">
          Hủy bỏ
        </button>

        <button type="button" (click)="confirmDelete()" [disabled]="deletingUser"
          class="px-5 py-2.5 bg-red-600 text-xs rounded-md hover:bg-red-700 font-semibold text-white border border-transparent shadow-md disabled:opacity-50 transition-all">
          <i *ngIf="deletingUser" class="fas fa-circle-notch fa-spin mr-2"></i>
          {{ deletingUser ? 'Đang xóa...' : 'Xác nhận' }}
        </button>
      </div>
    </div>
  </div>
</div>